@using Core.Entities.Tasks
@model IEnumerable<Core.Entities.Tasks.EmployeeTask>

@{
    string filterType = ViewBag.FilterType as string ?? "All";
    ViewData["Title"] = ViewData["Title"] ?? "Задачи";
    bool hideCompleted = filterType != "Completed"; 

    // ЯВНОЕ УКАЗАНИЕ ТИПА ДЛЯ ИЗБЕЖАНИЯ КОНФЛИКТА
    var statusNames = new Dictionary<Core.Entities.Tasks.TaskStatus, string>
    {
        { Core.Entities.Tasks.TaskStatus.Created, "Новая" },
        { Core.Entities.Tasks.TaskStatus.InProgress, "В работе" },
        { Core.Entities.Tasks.TaskStatus.InReview, "На проверке" },
        { Core.Entities.Tasks.TaskStatus.Completed, "Готова" }
    };
}

<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>

<style>
    /* СТИЛИ */
    .kanban-board { display: flex; overflow-x: auto; padding-bottom: 20px; gap: 20px; min-height: 70vh; }
    .kanban-column { flex: 0 0 320px; display: flex; flex-direction: column; background-color: #f4f6f8; border-radius: 10px; border: 1px solid #e1e4e8; }
    .kanban-header { padding: 12px 15px; border-bottom: 1px solid #e1e4e8; font-weight: 600; text-transform: uppercase; font-size: 0.8rem; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; align-items: center; }
    .kanban-tasks-list { flex-grow: 1; padding: 10px; overflow-y: auto; }
    .kanban-card { background: white; border: 1px solid #dfe1e5; border-radius: 6px; padding: 12px; margin-bottom: 10px; cursor: grab; border-left: 4px solid transparent; }
    .kanban-column[data-status-id="0"] .kanban-card { border-left-color: #6c757d; }
    .kanban-column[data-status-id="1"] .kanban-card { border-left-color: #0d6efd; }
    .kanban-column[data-status-id="2"] .kanban-card { border-left-color: #fd7e14; }
    .kanban-column[data-status-id="3"] .kanban-card { border-left-color: #198754; }
    #calendar { background: white; padding: 20px; border-radius: 8px; }
</style>

<div class="container-fluid px-0">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1"><i class="bi bi-list-check"></i> @ViewData["Title"]</h2>
            <div class="text-muted small">Управление задачами</div>
        </div>
        <a asp-action="Create" class="btn btn-primary">
            <i class="bi bi-plus-lg"></i> Поставить задачу
        </a>
    </div>

    <ul class="nav nav-tabs mb-4" id="viewTabs" role="tablist">
        <li class="nav-item"><button class="nav-link active" id="list-tab" data-bs-toggle="tab" data-bs-target="#view-list" onclick="saveTab('view-list')"><i class="bi bi-list-ul"></i> Список</button></li>
        <li class="nav-item"><button class="nav-link" id="kanban-tab" data-bs-toggle="tab" data-bs-target="#view-kanban" onclick="saveTab('view-kanban')"><i class="bi bi-kanban"></i> Канбан</button></li>
        <li class="nav-item"><button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#view-calendar" onclick="saveTab('view-calendar')"><i class="bi bi-calendar3"></i> Календарь</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="view-list">
            <div class="card shadow-sm border-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Создана</th>
                                <th>Задача</th>
                                <th>Исполнитель</th>
                                <th>Срок</th>
                                <th>Статус</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td class="small text-muted">@item.CreatedAt.ToString("dd.MM HH:mm")</td>
                                    <td><a asp-action="Details" asp-route-id="@item.Id" class="fw-bold text-dark text-decoration-none">@item.Title</a></td>
                                    <td>@(item.Assignee?.FullName ?? "-")</td>
                                    <td>
                                        @if (item.Deadline.HasValue)
                                        {
                                            <span class="@(item.Deadline < DateTime.UtcNow && item.Status != Core.Entities.Tasks.TaskStatus.Completed ? "text-danger fw-bold" : "")">
                                                @item.Deadline.Value.ToString("dd.MM.yyyy")
                                            </span>
                                        }
                                    </td>
                                    <td>
                                        @{
                                            string ruStatus = statusNames.ContainsKey(item.Status) ? statusNames[item.Status] : item.Status.ToString();
                                            string badgeClass = item.Status switch { 
                                                Core.Entities.Tasks.TaskStatus.Created => "bg-secondary", 
                                                Core.Entities.Tasks.TaskStatus.InProgress => "bg-primary", 
                                                Core.Entities.Tasks.TaskStatus.InReview => "bg-warning text-dark", 
                                                Core.Entities.Tasks.TaskStatus.Completed => "bg-success", 
                                                _ => "bg-secondary" 
                                            };
                                        }
                                        <span class="badge @badgeClass">@ruStatus</span>
                                    </td>
                                    <td class="text-end"><a asp-action="Details" asp-route-id="@item.Id" class="btn btn-sm btn-light"><i class="bi bi-eye"></i></a></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="tab-pane fade" id="view-kanban">
            <div class="kanban-board">
                @foreach (var kvp in statusNames)
                {
                    if (hideCompleted && kvp.Key == Core.Entities.Tasks.TaskStatus.Completed) continue;

                    <div class="kanban-column" data-status-id="@((int)kvp.Key)">
                        <div class="kanban-header">
                            @kvp.Value
                            <span class="badge bg-secondary rounded-pill">@Model.Count(x => x.Status == kvp.Key)</span>
                        </div>
                        <div class="kanban-tasks-list">
                            @foreach (var task in Model.Where(x => x.Status == kvp.Key))
                            {
                                <div class="kanban-card" data-task-id="@task.Id" onclick="location.href='@Url.Action("Details", new { id = task.Id })'">
                                    <div class="fw-bold mb-2">@task.Title</div>
                                    <div class="d-flex justify-content-between align-items-center small text-muted">
                                        <span><i class="bi bi-person"></i> @(task.Assignee?.FullName.Split(' ')[0] ?? "?")</span>
                                        @if(task.Deadline.HasValue) { <span class="@(task.Deadline < DateTime.UtcNow ? "text-danger" : "")">@task.Deadline.Value.ToString("dd.MM")</span> }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="tab-pane fade" id="view-calendar">
            <div id="calendar"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function saveTab(tabId) { localStorage.setItem('activeTaskTab', tabId); }
        document.addEventListener('DOMContentLoaded', function () {
            const activeTab = localStorage.getItem('activeTaskTab');
            if (activeTab) {
                const el = document.querySelector(`button[data-bs-target="#${activeTab}"]`);
                if(el) new bootstrap.Tab(el).show();
            }

            // KANBAN
            document.querySelectorAll('.kanban-tasks-list').forEach(col => {
                new Sortable(col, {
                    group: 'kanban', animation: 150, delay: 100, delayOnTouchOnly: true,
                    onEnd: function (evt) {
                        if(evt.from === evt.to && evt.oldIndex === evt.newIndex) return;
                        const statusId = evt.to.closest('.kanban-column').getAttribute('data-status-id');
                        const taskId = evt.item.getAttribute('data-task-id');
                        $.post('/Tasks/UpdateStatus', { id: taskId, status: statusId })
                            .fail(() => { alert('Ошибка!'); window.location.reload(); });
                    }
                });
            });

            // CALENDAR
            var calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: 'dayGridMonth', locale: 'ru', firstDay: 1,
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,listWeek' },
                buttonText: { today: 'Сегодня', month: 'Месяц', week: 'Неделя', list: 'Список' },
                events: '/Tasks/GetCalendarEvents?filter=@filterType',
                eventClick: function(info) {
                    if (info.event.url) { window.location.href = info.event.url; info.jsEvent.preventDefault(); }
                }
            });
            document.getElementById('calendar-tab').addEventListener('shown.bs.tab', () => calendar.render());
        });
    </script>
}