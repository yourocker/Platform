@model Core.Entities.Platform.AppDefinition
@{
    ViewData["Title"] = "Редактирование сущности";
}

<style>
    .icon-box {
        padding: 1.5rem 0.5rem; border: 1px solid #f0f0f0; border-radius: 10px;
        transition: 0.1s; cursor: pointer; background: #fff; height: 100%;
        display: flex; align-items: center; justify-content: center;
    }
    .icon-box:hover { background-color: var(--primary-color); color: #fff !important; transform: scale(1.1); z-index: 5; }
    .icon-box i { font-size: 1.8rem; }
    #IconInput[readonly] { background-color: #f8f9fa; cursor: default; }
</style>

<div class="container-fluid px-4">
    @* --- ХЕДЕР СТРАНИЦЫ --- *@
    <crm-page-header title="Редактирование сущности" icon="pencil-square" subtitle="Изменение параметров объекта @Model.Name"></crm-page-header>

    <div class="row">
        <div class="col-lg-8">
            <div crm-card>
                <div class="card-body p-4">
                    <form asp-action="Edit" method="post">
                        @* Системные скрытые поля *@
                        <input type="hidden" asp-for="Id" />
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3 small fw-bold"></div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <crm-input label="Название (в меню)" asp-for="Name"></crm-input>
                            </div>
                            <div class="col-md-6">
                                <crm-input label="Системный код (неизменяемый)" asp-for="EntityCode" class="bg-light" readonly></crm-input>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-6">
                                <crm-input label="Раздел меню">
                                    <select asp-for="AppCategoryId" class="form-select form-select-sm shadow-none" asp-items="ViewBag.Categories">
                                        <option value="">-- Не отображать в меню --</option>
                                    </select>
                                </crm-input>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label small fw-bold text-muted text-uppercase">Иконка приложения</label>
                                    <div class="input-group shadow-sm">
                                        <span class="input-group-text bg-white">
                                            <i id="iconPreview" class="bi bi-@Model.Icon text-primary"></i>
                                        </span>
                                        <input asp-for="Icon" id="IconInput" class="form-control" readonly />
                                        <button type="button" class="btn btn-outline-primary shadow-none" data-bs-toggle="modal" data-bs-target="#iconModal">Сменить</button>
                                    </div>
                                    <span asp-validation-for="Icon" class="text-danger small"></span>
                                </div>
                            </div>
                        </div>

                        <crm-input label="Описание сущности">
                            <textarea asp-for="Description" class="form-control shadow-none" rows="1" placeholder="Укажите назначение данной сущности..."></textarea>
                        </crm-input>

                        <div class="mb-4">
                            <div class="form-check form-switch p-0 d-flex align-items-center gap-3">
                                <input asp-for="IsSystem" class="form-check-input ms-0 shadow-none" type="checkbox" />
                                <label asp-for="IsSystem" class="form-check-label small fw-bold text-muted text-uppercase">Системная сущность (защита от удаления)</label>
                            </div>
                        </div>

                        <hr class="my-4 opacity-50">

                        <div class="d-flex justify-content-between align-items-center">
                            <a asp-action="Fields" asp-route-id="@Model.Id" crm-button variant="outline-info" icon="list-check" class="shadow-sm">
                                Настроить поля
                            </a>
                            <div class="d-flex gap-2">
                                <button type="submit" crm-button variant="primary" icon="check-lg" class="px-5 shadow-sm">Сохранить</button>
                                <a asp-action="Index" crm-button variant="outline-secondary" class="shadow-sm">Отмена</a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@* --- МОДАЛЬНОЕ ОКНО ВЫБОРА ИКОНОК --- *@
<div class="modal fade" id="iconModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title fw-bold">Библиотека иконок</h5>
                <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalScrollBody">
                <div class="row row-cols-3 row-cols-md-6 g-3" id="iconGrid"></div>
                <div id="sentinel" style="height: 10px;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const icons = ['archive','alarm','app','award','bank','basket','bell','book','bookmark','box','briefcase','calendar-date','camera','card-text','cart','chat','check-circle','clipboard','clock','cloud','code-slash','cpu','credit-card','database','display','envelope','file-earmark','flag','folder','gear','graph-up','grid','heart','house','image','inbox','info-circle','journal','kanban','key','laptop','layers','list-task','lock','map','megaphone','mic','mouse','music-note','patch-check','pci-card','pencil','person','phone','pie-chart','play-circle','plus-circle','printer','puzzle','qr-code','question-circle','receipt','save','search','server','shield','shop','sliders','star','sticky','tablet','tag','terminal','tools','trash','truck','tv','unlock','upload','wallet','watch','whatsapp','wifi','wrench','zoom-in','shield-check','box-seam','truck-flatbed','house-door','person-badge','person-gear','people-fill','telephone','envelope-at','globe-europe-africa','lightning','bug','fire','gem','magic','plugin','command','terminal-fill','layers-half','stack'];
    let offset = 0, rendering = false;
    const grid = document.getElementById('iconGrid'), sentinel = document.getElementById('sentinel');

    const draw = () => {
        if (rendering || offset >= icons.length) return;
        rendering = true;
        const batch = icons.slice(offset, offset + 60);
        grid.insertAdjacentHTML('beforeend', batch.map(n => `<div class="col"><div class="icon-box" onclick="selectIcon('${n}')"><i class="bi bi-${n}"></i></div></div>`).join(''));
        offset += 60;
        setTimeout(() => { rendering = false; }, 50);
    };

    new IntersectionObserver(e => { if(e[0].isIntersecting) draw(); }, { root: document.getElementById('modalScrollBody') }).observe(sentinel);

    window.selectIcon = (n) => {
        document.getElementById('IconInput').value = n;
        document.getElementById('iconPreview').className = `bi bi-${n} text-primary`;
        document.getElementById('icon-name-display')?.innerText ? document.getElementById('icon-name-display').innerText = n : null;
        bootstrap.Modal.getInstance(document.getElementById('iconModal')).hide();
    };
</script>