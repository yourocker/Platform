@model Core.Entities.Platform.AppCategory
@{
ViewData["Title"] = "Новый раздел";
}

<style>
    .icon-box {
        padding: 1.5rem 0.5rem; border: 1px solid #f0f0f0; border-radius: 10px;
        transition: 0.1s; cursor: pointer; background: #fff; height: 100%;
        display: flex; align-items: center; justify-content: center;
    }
    .icon-box:hover { background-color: var(--primary-color); color: #fff !important; transform: scale(1.1); z-index: 5; }
    .icon-box i { font-size: 1.8rem; }
    #IconInput[readonly] { background-color: #f8f9fa; cursor: default; }
</style>

<div class="container-fluid px-4">
    <crm-page-header title="Новый раздел" icon="plus-circle-fill" subtitle="Создание нового элемента навигации"></crm-page-header>

    <div class="row">
        <div class="col-md-8 col-lg-6">
            <div crm-card>
                <div class="card-body p-4">
                    <form asp-action="Create" method="post">
                        @* Обязательно указываем скрытые поля *@
                        <input type="hidden" asp-for="IsSystem" value="false" />

                        <div asp-validation-summary="All" class="text-danger mb-3 small fw-bold"></div>

                        @* Теперь asp-for передаст имя "Name" в хелпер корректно *@
                        <crm-input label="Название раздела" asp-for="Name" placeholder="Напр: Склад, Отчеты..."></crm-input>

                        <crm-input label="Порядок сортировки" asp-for="SortOrder" type="number" placeholder="0"></crm-input>

                        <div class="mb-4">
                            <label class="form-label fw-bold small text-muted text-uppercase">Иконка раздела</label>
                            <div class="input-group shadow-sm">
                                <span class="input-group-text bg-white">
                                    <i id="iconPreview" class="bi bi-@(string.IsNullOrEmpty(Model?.Icon) ? "app" : Model.Icon) text-primary"></i>
                                </span>
                                @* Используем стандартный input здесь, так как он внутри input-group *@
                                <input asp-for="Icon" id="IconInput" class="form-control" readonly placeholder="Выберите иконку..." />
                                <button type="button" class="btn btn-outline-primary shadow-none" data-bs-toggle="modal" data-bs-target="#iconModal">Выбрать</button>
                            </div>
                            <span asp-validation-for="Icon" class="text-danger small"></span>
                        </div>

                        <hr class="my-4 opacity-50">

                        <div class="d-flex gap-2">
                            <button type="submit" crm-button variant="primary" icon="check-lg" class="px-4 shadow-sm">Создать раздел</button>
                            <a asp-action="Index" crm-button variant="outline-secondary" class="shadow-sm">Отмена</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@* Модальное окно выбора иконок (оставляем без изменений, оно работало) *@
<div class="modal fade" id="iconModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-bottom-0">
                <h5 class="modal-title fw-bold">Библиотека иконок</h5>
                <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalScrollBody">
                <div class="row row-cols-3 row-cols-md-6 g-3" id="iconGrid"></div>
                <div id="sentinel" style="height: 10px;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    const icons = ['archive','alarm','app','award','bank','basket','bell','book','bookmark','box','briefcase','calendar-date','camera','card-text','cart','chat','check-circle','clipboard','clock','cloud','code-slash','cpu','credit-card','database','display','envelope','file-earmark','flag','folder','gear','graph-up','grid','heart','house','image','inbox','info-circle','journal','kanban','key','laptop','layers','list-task','lock','map','megaphone','mic','mouse','music-note','patch-check','pci-card','pencil','person','phone','pie-chart','play-circle','plus-circle','printer','puzzle','qr-code','question-circle','receipt','save','search','server','shield','shop','sliders','star','sticky','tablet','tag','terminal','tools','trash','truck','tv','unlock','upload','wallet','watch','whatsapp','wifi','wrench','zoom-in','shield-check','box-seam','truck-flatbed','house-door','person-badge','person-gear','people-fill','telephone','envelope-at','globe-europe-africa','lightning','bug','fire','gem','magic','plugin','command','terminal-fill','layers-half','stack'];
    let offset = 0, rendering = false;
    const grid = document.getElementById('iconGrid'), sentinel = document.getElementById('sentinel');

    const draw = () => {
        if (rendering || offset >= icons.length) return;
        rendering = true;
        const batch = icons.slice(offset, offset + 60);
        grid.insertAdjacentHTML('beforeend', batch.map(n => `<div class="col"><div class="icon-box" onclick="selectIcon('${n}')"><i class="bi bi-${n}"></i></div></div>`).join(''));
        offset += 60;
        setTimeout(() => { rendering = false; }, 50);
    };

    new IntersectionObserver(e => { if(e[0].isIntersecting) draw(); }, { root: document.getElementById('modalScrollBody') }).observe(sentinel);

    window.selectIcon = (n) => {
        document.getElementById('IconInput').value = n;
        document.getElementById('iconPreview').className = `bi bi-${n} text-primary`;
        bootstrap.Modal.getInstance(document.getElementById('iconModal')).hide();
    };
</script>