@using Core.Entities.CRM
@using Core.Entities.Platform
@using System.Text.Json
@model CRM.ViewModels.CRM.LeadsViewModel
@{
    ViewData["Title"] = "Лиды";
    var ui = (Context.RequestServices.GetService(typeof(Core.Services.ICrmStyleService)) as Core.Services.ICrmStyleService)?.GetSettings();
    var primaryColor = ui?.PrimaryColor ?? "#0d6efd"; // Страховка, если сервис вернет null
}

<div class="container-fluid px-4">
    @* --- ХЕДЕР (Чистый HTML, чтобы ничего не упало) --- *@
    <div class="row mb-4 align-items-center justify-content-between pt-4">
        <div class="col-auto d-flex align-items-center">
            <i class="bi bi-person-plus me-2 fs-3" style="color: @primaryColor;"></i>
            <div>
                <h3 class="mb-0 fw-bold text-secondary text-uppercase">Лиды</h3>
                <span class="text-muted small">@Model.CurrentPipeline?.Name</span>
            </div>
        </div>

        <div class="col-auto d-flex gap-2 align-items-center">
            @* Выбор воронки *@
            <div class="dropdown">
                <button class="btn btn-white border shadow-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Воронка: @Model.CurrentPipeline?.Name
                </button>
                <ul class="dropdown-menu shadow border-0">
                    @foreach (var p in Model.AllPipelines)
                    {
                        <li>
                            <a class="dropdown-item @(p.Id == Model.CurrentPipeline?.Id ? "active" : "")" 
                               asp-route-pipelineId="@p.Id" asp-route-view="@Model.ViewMode">@p.Name</a>
                        </li>
                    }
                </ul>
            </div>

            @* ПЕРЕКЛЮЧАТЕЛЬ (Канбан / Список) *@
            <div class="btn-group shadow-sm">
                <a asp-route-view="kanban" asp-route-pipelineId="@Model.CurrentPipeline?.Id" 
                   class="btn @(Model.ViewMode == "kanban" ? "btn-primary" : "btn-white border")">
                    <i class="bi bi-columns-gap me-2"></i>Канбан
                </a>
                <a asp-route-view="list" asp-route-pipelineId="@Model.CurrentPipeline?.Id" 
                   class="btn @(Model.ViewMode == "list" ? "btn-primary" : "btn-white border")">
                    <i class="bi bi-list-ul me-2"></i>Список
                </a>
            </div>

            <button class="btn btn-white border shadow-sm" data-bs-toggle="collapse" data-bs-target="#filterPanel">
                <i class="bi bi-funnel me-2"></i>Фильтры
            </button>
            
            <a asp-action="Create" class="btn btn-primary px-4 shadow-sm" style="background-color: @primaryColor; border-color: @primaryColor;">
                <i class="bi bi-plus-lg me-2"></i>Добавить запись
            </a>
        </div>
    </div>

    @* --- ПАНЕЛЬ ФИЛЬТРОВ --- *@
    <form asp-action="Index" method="get" id="mainFilterForm">
        <input type="hidden" name="view" value="@Model.ViewMode" />
        <input type="hidden" name="pipelineId" value="@Model.CurrentPipeline?.Id" />
        <input type="hidden" name="pageSize" value="@Model.PageSize" id="hiddenPageSize" />
        <input type="hidden" name="pageNumber" value="@Model.PageNumber" id="hiddenPageNumber" />

        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body p-3">
                <div class="input-group input-group-lg border rounded-3 overflow-hidden shadow-sm mb-0">
                    <span class="input-group-text bg-white border-0"><i class="bi bi-search" style="color: @primaryColor"></i></span>
                    <input type="text" name="searchString" value="@Model.SearchString" class="form-control border-0 shadow-none instant-filter" placeholder="Поиск лидов..." autocomplete="off"/>
                </div>

                <div class="collapse @(Model.ActiveFilters.Any() ? "show" : "")" id="filterPanel">
                    <div class="pt-4 mt-3 border-top">
                        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-3">
                            @foreach (var field in Model.DynamicFields)
                            {
                                <div class="col">
                                    <label class="form-label small fw-bold text-muted">@field.Label</label>
                                    <input type="text" name="f_@field.SystemName" 
                                           value="@(Model.ActiveFilters.GetValueOrDefault("f_" + field.SystemName))" 
                                           class="form-control form-control-sm instant-filter" />
                                </div>
                            }
                        </div>
                        <div class="text-end mt-3">
                            <a asp-action="Index" asp-route-pipelineId="@Model.CurrentPipeline?.Id" class="btn btn-link btn-sm text-danger text-decoration-none">Сбросить всё</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

    @* --- КОНТЕНТ --- *@
    <div class="mt-2">
        @if (Model.ViewMode == "kanban")
        {
            @await Html.PartialAsync("_LeadsKanban", Model)
        }
        else
        {
            @await Html.PartialAsync("_LeadsList", Model)
        }
    </div>

    @* --- ПАГИНАЦИЯ --- *@
    @if (Model.ViewMode == "list" && Model.TotalPages > 1)
    {
        <crm-pagination total-pages="@Model.TotalPages" current-page="@Model.PageNumber" action="Index" />
    }
</div>

@section Scripts {
    <script>
        let filterTimeout;
        document.querySelectorAll('.instant-filter').forEach(el => {
            el.addEventListener('input', function() {
                clearTimeout(filterTimeout);
                filterTimeout = setTimeout(() => {
                    document.getElementById('hiddenPageNumber').value = 1;
                    document.getElementById('mainFilterForm').submit();
                }, 700);
            });
        });
    </script>
}