@using Core.Entities.Platform
@using System.Text.Json
@model Core.Entities.IHasDynamicProperties
@using Microsoft.AspNetCore.Html

@{
    var fields = ViewBag.DynamicFields as List<AppFieldDefinition>;
    var lookupData = ViewBag.LookupData as Dictionary<string, List<SelectListItem>> ?? new Dictionary<string, List<SelectListItem>>();
    var values = new Dictionary<string, object>();
    
    if (!string.IsNullOrEmpty(Model?.Properties))
    {
        try { 
            values = JsonSerializer.Deserialize<Dictionary<string, object>>(Model.Properties) ?? new Dictionary<string, object>(); 
        }
        catch { }
    }

    // Определяем режим (создание/редактирование или просмотр)
    var action = ViewContext.RouteData.Values["action"]?.ToString();
    bool isEditMode = action == "Create" || action == "Edit";
}

@* Подключаем Select2 для поиска в больших списках *@
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />

@if (fields != null && fields.Any())
{
    <div class="mt-4 mb-3 pt-3 border-top">
        <h5 class="text-secondary mb-3">Дополнительные параметры</h5>
    </div>

    <div class="container-fluid px-0">
        @foreach (var field in fields.OrderBy(f => f.SortOrder))
        {
            var formKey = $"DynamicProps[{field.SystemName}]";
            var hasError = ViewData.ModelState.ContainsKey(formKey) && ViewData.ModelState[formKey].Errors.Any();
            
            values.TryGetValue(field.SystemName, out var rawValue);
            
            var currentValues = new List<string>();
            if (rawValue is JsonElement element)
            {
                if (element.ValueKind == JsonValueKind.Array)
                    currentValues = element.EnumerateArray().Select(x => x.ToString()).ToList();
                else
                    currentValues.Add(element.ToString());
            }
            else if (rawValue != null)
            {
                currentValues.Add(rawValue.ToString());
            }

            if (!currentValues.Any()) currentValues.Add("");

            <div class="row mb-3 align-items-start">
                <label class="col-sm-2 col-form-label text-muted text-sm-end fw-bold">
                    @field.Label
                    @if (field.IsRequired && isEditMode) { <span class="text-danger">*</span> }
                </label>

                <div class="col-sm-10">
                    <div id="container_@field.SystemName" class="dynamic-field-container">
                        @foreach (var val in currentValues)
                        {
                            var wrapperId = "wrapper_" + Guid.NewGuid().ToString("N");
                            var recordId = (Model is Core.Entities.Platform.GenericObject go) ? go.Id.ToString() : "";

                            <div class="input-group mb-2 dynamic-field-item flex-column" id="@wrapperId">
                                @if (field.DataType == FieldDataType.File && !string.IsNullOrWhiteSpace(val) && !val.Contains("/uploads/temp/"))
                                {
                                    <div class="mb-1 d-flex align-items-center">
                                        <a href="@val" target="_blank" class="text-decoration-none small">
                                            <i class="bi bi-paperclip"></i> Текущий файл: @System.IO.Path.GetFileName(val)
                                        </a>
                                        @if (!string.IsNullOrEmpty(recordId))
                                        {
                                            <button type="button" class="btn btn-link text-danger p-0 ms-2" title="Удалить файл"
                                                    onclick="deleteExistingFile('@recordId', '@ViewBag.EntityCode', '@field.SystemName', '@val', '@wrapperId')">
                                                <i class="bi bi-x-circle-fill"></i>
                                            </button>
                                        }
                                    </div>
                                }
                                
                                <div class="d-flex w-100">
                                    @if (isEditMode)
                                    {
                                        @renderField(field, val, hasError, lookupData)
                                        
                                        @if (field.IsArray)
                                        {
                                            <button type="button" class="btn btn-outline-danger" onclick="this.closest('.dynamic-field-item').remove()">
                                                <i class="bi bi-x"></i>
                                            </button>
                                        }
                                    }
                                    else
                                    {
                                        @* ОТОБРАЖЕНИЕ В ЗАПИСИ (ПРОСМОТР) *@
                                        @if (field.DataType == FieldDataType.EntityLink)
                                        {
                                            var displayName = lookupData.ContainsKey(field.SystemName) 
                                                ? lookupData[field.SystemName].FirstOrDefault(x => x.Value == val)?.Text ?? "Запись не найдена"
                                                : val;

                                            if (!string.IsNullOrEmpty(val))
                                            {
                                                <a href="/Data/@field.TargetEntityCode" class="btn btn-outline-primary btn-sm">
                                                    <i class="bi bi-link-45deg"></i> @displayName
                                                </a>
                                            }
                                            else { <span class="text-muted small">Не указано</span> }
                                        }
                                        else
                                        {
                                            <div class="form-control-plaintext">@(string.IsNullOrEmpty(val) ? "—" : val)</div>
                                        }
                                    }
                                </div>
                                
                                @* Ссылочность: прямая ссылка на объект под полем выбора при редактировании *@
                                @if (isEditMode && field.DataType == FieldDataType.EntityLink && !string.IsNullOrEmpty(val))
                                {
                                    <div class="mt-1">
                                        <a href="/Data/@field.TargetEntityCode" target="_blank" class="text-primary small">
                                            <i class="bi bi-box-arrow-up-right"></i> Перейти к справочнику
                                        </a>
                                    </div>
                                }
                            </div>
                        }
                    </div>

                    @if (hasError && isEditMode)
                    {
                        <div class="text-danger small mt-1">
                            @foreach (var error in ViewData.ModelState[formKey].Errors)
                            {
                                <div><i class="bi bi-exclamation-circle"></i> @error.ErrorMessage</div>
                            }
                        </div>
                    }

                    @if (field.IsArray && isEditMode)
                    {
                        <button type="button" class="btn btn-sm btn-outline-secondary mt-1" 
                                onclick="addDynamicField('@field.SystemName', '@field.DataType')">
                            <i class="bi bi-plus-lg"></i> Добавить еще
                        </button>
                    }
                </div>
            </div>
        }
    </div>

    @* Шаблоны для JS *@
    <div id="field_templates" style="display:none;">
        <div data-type="String"><input type="text" class="form-control" /></div>
        <div data-type="Number"><input type="number" step="any" class="form-control" /></div>
        <div data-type="Money"><input type="number" step="0.01" class="form-control" placeholder="0.00" /></div>
        <div data-type="Date"><input type="date" class="form-control" /></div>
        <div data-type="DateTime"><input type="datetime-local" class="form-control" /></div>
        <div data-type="File"><input type="file" class="form-control" /></div>
        <div data-type="Boolean">
            <div class="form-check form-switch mt-2">
                <input class="form-check-input" type="checkbox" value="true">
            </div>
        </div>
        <div data-type="EntityLink">
            <select class="form-control select2-entity">
                <option value="">-- Выберите --</option>
            </select>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        function initSelect2(element) {
            $(element).select2({
                theme: "bootstrap-5",
                width: '100%',
                placeholder: "Поиск записей...",
                allowClear: true,
                dropdownParent: $(element).closest('.col-sm-10')
            });
        }

        $(document).ready(function() {
            $('.select2-entity').each(function() {
                initSelect2(this);
            });
        });

        function addDynamicField(systemName, dataType) {
            const container = document.getElementById('container_' + systemName);
            const template = document.querySelector(`#field_templates [data-type="${dataType}"]`) 
                          || document.querySelector(`#field_templates [data-type="String"]`);
            
            const wrapper = document.createElement('div');
            wrapper.className = 'input-group mb-2 dynamic-field-item';
            
            const content = template.cloneNode(true);
            const input = content.querySelector('input') || content.querySelector('textarea') || content.querySelector('select');
            input.name = `DynamicProps[${systemName}]`;

            // Копируем опции для EntityLink из существующего скрытого шаблона или первого селекта
            if (dataType === 'EntityLink') {
                const sourceSelect = document.querySelector(`select[name="DynamicProps[${systemName}]"]`);
                if (sourceSelect) {
                    input.innerHTML = sourceSelect.innerHTML;
                }
            }
            
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-outline-danger';
            btn.innerHTML = '<i class="bi bi-x"></i>';
            btn.onclick = function() { this.closest('.dynamic-field-item').remove(); };
            
            wrapper.appendChild(content.classList.contains('form-check') ? content : content.firstElementChild || content);
            wrapper.appendChild(btn);
            container.appendChild(wrapper);

            if (dataType === 'EntityLink') {
                initSelect2(input);
            }
        }

        function deleteExistingFile(id, entityCode, propName, path, wrapperId) {
            if (!confirm('Удалить этот файл?')) return;
            const formData = new FormData();
            formData.append('id', id);
            formData.append('entityCode', entityCode);
            formData.append('propertyName', propName);
            formData.append('filePath', path);
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value || '';

            fetch('/GenericObjects/DeleteFileProperty', {
                method: 'POST',
                body: formData,
                headers: { 'RequestVerificationToken': token }
            }).then(r => r.json()).then(d => {
                if (d.success) document.getElementById(wrapperId).querySelector('.mb-1')?.remove();
            });
        }
    </script>
}

@functions {
    IHtmlContent renderField(AppFieldDefinition field, string value, bool hasError, Dictionary<string, List<SelectListItem>> lookupData)
    {
        var fieldName = $"DynamicProps[{field.SystemName}]";
        var required = field.IsRequired ? "required" : "";
        var errorClass = hasError ? "is-invalid" : "";
        
        switch (field.DataType)
        {
            case FieldDataType.EntityLink:
                var options = new System.Text.StringBuilder();
                options.Append("<option value=\"\"></option>");
                if (lookupData.TryGetValue(field.SystemName, out var items))
                {
                    foreach (var item in items)
                    {
                        var sel = item.Value == value ? "selected" : "";
                        options.Append($"<option value=\"{item.Value}\" {sel}>{item.Text}</option>");
                    }
                }
                return new HtmlString($"<select name=\"{fieldName}\" class=\"form-control select2-entity {errorClass}\" {required}>{options}</select>");

            case FieldDataType.Number:
                return new HtmlString($"<input type=\"number\" step=\"any\" name=\"{fieldName}\" value=\"{valForInput(value)}\" class=\"form-control {errorClass}\" {required} />");
            case FieldDataType.Money:
                return new HtmlString($"<input type=\"number\" step=\"0.01\" name=\"{fieldName}\" value=\"{valForInput(value)}\" class=\"form-control {errorClass}\" placeholder=\"0.00\" {required} />");
            case FieldDataType.Date:
                return new HtmlString($"<input type=\"date\" name=\"{fieldName}\" value=\"{valForDate(value)}\" class=\"form-control {errorClass}\" {required} />");
            case FieldDataType.DateTime:
                return new HtmlString($"<input type=\"datetime-local\" name=\"{fieldName}\" value=\"{valForDate(value, true)}\" class=\"form-control {errorClass}\" {required} />");
            case FieldDataType.File:
                return new HtmlString($"<input type=\"file\" name=\"{fieldName}\" class=\"form-control {errorClass}\" {required} />");
            case FieldDataType.Boolean:
                var checkedAttr = value.ToLower() == "true" ? "checked" : "";
                return new HtmlString($@"<div class=""form-check form-switch mt-2""><input type=""hidden"" name=""{fieldName}"" value=""false"" /><input class=""form-check-input"" type=""checkbox"" name=""{fieldName}"" value=""true"" {checkedAttr} /></div>");
            case FieldDataType.Text:
                return new HtmlString($"<textarea name=\"{fieldName}\" class=\"form-control {errorClass}\" rows=\"3\" {required}>{value}</textarea>");
            default:
                return new HtmlString($"<input type=\"text\" name=\"{fieldName}\" value=\"{value}\" class=\"form-control {errorClass}\" {required} />");
        }
    }

    string valForInput(string val) => val?.Replace(",", ".");
    string valForDate(string val, bool isDateTime = false) {
        if (DateTime.TryParse(val, out DateTime dt)) return dt.ToString(isDateTime ? "yyyy-MM-ddTHH:mm" : "yyyy-MM-dd");
        return "";
    }
}