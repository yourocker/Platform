@using Core.Entities.CRM
@using Core.Entities.Platform
@using System.Text.Json
@model IEnumerable<Contact>
@{
ViewData["Title"] = "Контакты";
var dynamicFields = ViewBag.DynamicFields as List<AppFieldDefinition> ?? new List<AppFieldDefinition>();

// Метаданные пагинации
int totalItems = ViewBag.TotalItems;
int pageNumber = ViewBag.PageNumber;
int pageSize = ViewBag.PageSize;
int totalPages = ViewBag.TotalPages;
string currentSearch = ViewBag.CurrentSearch;
var currentFilters = ViewBag.CurrentFilters as Dictionary<string, string> ?? new Dictionary<string, string>();
}

<div class="container-fluid px-4">
    @* --- ХЕДЕР: ЗАГОЛОВОК И УПРАВЛЕНИЕ КОЛОНКАМИ --- *@
    <div class="row mb-4 align-items-center justify-content-between">
        <div class="col-auto">
            <h3 class="mb-0 fw-bold text-secondary"><i class="bi bi-person-lines-fill me-2"></i>Контакты</h3>
            <span class="text-muted small">Всего найдено: <strong>@totalItems</strong></span>
        </div>
        <div class="col-auto d-flex gap-2">
            @* Настройка всех доступных колонок *@
            <div class="dropdown">
                <button class="btn btn-outline-secondary dropdown-toggle shadow-sm" type="button" id="columnToggle" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                    <i class="bi bi-view-list me-1"></i> Вид таблицы
                </button>
                <ul class="dropdown-menu shadow border-0" aria-labelledby="columnToggle" id="columnSelector" style="max-height: 500px; overflow-y: auto; min-width: 250px;">
                    <li><h6 class="dropdown-header">Системные поля</h6></li>
                    <li><div class="dropdown-item"><div class="form-check"><input class="form-check-input col-chk" type="checkbox" value="col-fullname" checked> <label class="form-check-label">ФИО (Полное)</label></div></div></li>
                    <li><div class="dropdown-item"><div class="form-check"><input class="form-check-input col-chk" type="checkbox" value="col-lastname" checked> <label class="form-check-label">Фамилия</label></div></div></li>
                    <li><div class="dropdown-item"><div class="form-check"><input class="form-check-input col-chk" type="checkbox" value="col-firstname" checked> <label class="form-check-label">Имя</label></div></div></li>
                    <li><div class="dropdown-item"><div class="form-check"><input class="form-check-input col-chk" type="checkbox" value="col-middlename" checked> <label class="form-check-label">Отчество</label></div></div></li>
                    <li><div class="dropdown-item"><div class="form-check"><input class="form-check-input col-chk" type="checkbox" value="col-phone" checked> <label class="form-check-label">Телефон</label></div></div></li>
                    <li><div class="dropdown-item"><div class="form-check"><input class="form-check-input col-chk" type="checkbox" value="col-email" checked> <label class="form-check-label">Email</label></div></div></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><h6 class="dropdown-header">Дополнительные поля (Конструктор)</h6></li>
                    @foreach (var field in dynamicFields)
                    {
                    <li>
                        <div class="dropdown-item">
                            <div class="form-check">
                                <input class="form-check-input col-chk" type="checkbox" value="col-dyn-@field.SystemName" checked>
                                <label class="form-check-label">@field.Label</label>
                            </div>
                        </div>
                    </li>
                    }
                </ul>
            </div>

            <button class="btn btn-outline-primary shadow-sm" type="button" data-bs-toggle="collapse" data-bs-target="#filterPanel">
                <i class="bi bi-funnel me-1"></i> Фильтры
            </button>
            <a asp-action="Create" class="btn btn-primary shadow-sm px-4"><i class="bi bi-plus-lg me-1"></i> Создать</a>
        </div>
    </div>

    @* --- ФИЛЬТРЫ И ПОИСК --- *@
    <form asp-action="Index" method="get" id="mainFilterForm">
        @* Параметры пагинации *@
        <input type="hidden" name="pageSize" value="@pageSize" id="hiddenPageSize" />
        <input type="hidden" name="pageNumber" value="1" id="hiddenPageNumber" /> @* Сброс на 1 страницу при новом поиске *@

        <div class="card shadow-sm border-0 mb-4">
            <div class="card-body p-3">
                @* Быстрый поиск *@
                <div class="input-group input-group-lg border rounded-3 overflow-hidden">
                    <span class="input-group-text bg-white border-0"><i class="bi bi-search text-primary"></i></span>
                    <input type="text" name="searchString" value="@currentSearch" class="form-control border-0 shadow-none instant-filter" placeholder="Начните вводить для мгновенного поиска по всем полям..." autocomplete="off" />
                </div>

                @* Детальные фильтры (Спойлер) *@
                <div class="collapse @(currentFilters.Any() ? "show" : "")" id="filterPanel">
                    <div class="pt-4 mt-3 border-top">
                        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-3">
                            <div class="col">
                                <label class="form-label small fw-bold text-muted text-uppercase">Фамилия</label>
                                <input type="text" name="f_LastName" value="@(currentFilters.GetValueOrDefault("f_LastName"))" class="form-control form-control-sm instant-filter" />
                            </div>
                            <div class="col">
                                <label class="form-label small fw-bold text-muted text-uppercase">Имя</label>
                                <input type="text" name="f_FirstName" value="@(currentFilters.GetValueOrDefault("f_FirstName"))" class="form-control form-control-sm instant-filter" />
                            </div>
                            <div class="col">
                                <label class="form-label small fw-bold text-muted text-uppercase">Отчество</label>
                                <input type="text" name="f_MiddleName" value="@(currentFilters.GetValueOrDefault("f_MiddleName"))" class="form-control form-control-sm instant-filter" />
                            </div>
                            @foreach (var field in dynamicFields)
                            {
                            <div class="col">
                                <label class="form-label small fw-bold text-muted text-uppercase">@field.Label</label>
                                <input type="text" name="f_@field.SystemName" value="@(currentFilters.GetValueOrDefault("f_" + field.SystemName))" class="form-control form-control-sm instant-filter" />
                            </div>
                            }
                        </div>
                        <div class="text-end mt-3">
                            <a asp-action="Index" class="btn btn-link btn-sm text-danger">Очистить всё</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>

    @* --- ТАБЛИЦА --- *@
    <div class="card shadow-sm border-0 overflow-hidden">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0" id="contactsTable">
                <thead class="bg-light text-muted small text-uppercase">
                <tr>
                    <th class="ps-4 col-fullname">ФИО</th>
                    <th class="col-lastname">Фамилия</th>
                    <th class="col-firstname">Имя</th>
                    <th class="col-middlename">Отчество</th>
                    <th class="col-phone">Телефон</th>
                    <th class="col-email">Email</th>
                    @foreach (var field in dynamicFields)
                    {
                    <th class="col-dyn-@field.SystemName">@field.Label</th>
                    }
                    <th class="text-end pe-4">Действия</th>
                </tr>
                </thead>
                <tbody>
                @foreach (var item in Model) {
                var propValues = new Dictionary<string, object>();
                if (!string.IsNullOrEmpty(item.Properties)) {
                try { propValues = JsonSerializer.Deserialize<Dictionary<string, object>>(item.Properties) ?? new Dictionary<string, object>(); } catch { }
                }
                <tr>
                    <td class="ps-4 col-fullname"><div class="fw-bold"><a asp-action="Details" asp-route-id="@item.Id" class="text-decoration-none text-dark">@item.FullName</a></div></td>
                    <td class="col-lastname">@item.LastName</td>
                    <td class="col-firstname">@item.FirstName</td>
                    <td class="col-middlename">@item.MiddleName</td>
                    <td class="col-phone">@string.Join(", ", item.Phones.Select(p => p.Number))</td>
                    <td class="col-email">@string.Join(", ", item.Emails.Select(e => e.Email))</td>
                    @foreach (var field in dynamicFields) {
                    <td class="col-dyn-@field.SystemName">
                        @if (propValues.TryGetValue(field.SystemName, out var val) && val != null) {
                        if (val is JsonElement element && element.ValueKind == JsonValueKind.Array) {
                        <span class="badge bg-light text-dark border">@element.GetArrayLength() зап.</span>
                        } else { @val.ToString() }
                        } else { <span class="text-muted small">—</span> }
                    </td>
                    }
                    <td class="text-end pe-4">
                        <div class="btn-group btn-group-sm shadow-sm">
                            <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-white border" title="Редактировать"><i class="bi bi-pencil-fill text-primary"></i></a>
                            <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-white border" title="Просмотр"><i class="bi bi-eye-fill text-info"></i></a>
                            <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-white border" title="Удалить"><i class="bi bi-trash-fill text-danger"></i></a>
                        </div>
                    </td>
                </tr>
                }
                </tbody>
            </table>
        </div>

        @* --- ПАГИНАЦИЯ --- *@
        <div class="card-footer bg-white py-3 border-top">
            <div class="row align-items-center">
                <div class="col-md-3 text-muted small">
                    Показано <strong>@Model.Count()</strong> из <strong>@totalItems</strong> записей
                </div>
                <div class="col-md-6 d-flex justify-content-center">
                    <nav>
                        <ul class="pagination pagination-sm mb-0">
                            @{
                            var prevDisabled = pageNumber == 1 ? "disabled" : "";
                            var nextDisabled = pageNumber == totalPages || totalPages == 0 ? "disabled" : "";

                            // Формирование базовых параметров для ссылок пагинации
                            object GetRouteData(int p) {
                            var rd = new RouteValueDictionary { { "pageNumber", p }, { "pageSize", pageSize }, { "searchString", currentSearch } };
                            foreach(var f in currentFilters) rd.Add(f.Key, f.Value);
                            return rd;
                            }
                            }
                            <li class="page-item @prevDisabled">
                                <a class="page-link" href="@Url.Action("Index", GetRouteData(pageNumber - 1))"><i class="bi bi-chevron-left"></i></a>
                            </li>

                            @for (int i = 1; i <= totalPages; i++) {
                            if (i == 1 || i == totalPages || (i >= pageNumber - 2 && i <= pageNumber + 2)) {
                            <li class="page-item @(i == pageNumber ? "active" : "")">
                                <a class="page-link" href="@Url.Action("Index", GetRouteData(i))">@i</a>
                            </li>
                            } else if (i == pageNumber - 3 || i == pageNumber + 3) {
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                            }
                            }

                            <li class="page-item @nextDisabled">
                                <a class="page-link" href="@Url.Action("Index", GetRouteData(pageNumber + 1))"><i class="bi bi-chevron-right"></i></a>
                            </li>
                        </ul>
                    </nav>
                </div>
                <div class="col-md-3 text-end">
                    <div class="d-inline-flex align-items-center">
                        <span class="text-muted small me-2">На странице:</span>
                        <select class="form-select form-select-sm" style="width: auto;" onchange="changePageSize(this.value)">
                            @foreach (var size in new[] { 10, 25, 50, 100 }) {
                            <option value="@size" selected="@(pageSize == size)">@size</option>
                            }
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* --- СКРИПТЫ --- *@
<script>
    // 1. Мгновенная фильтрация с Debounce (задержкой)
    let filterTimeout;
    document.querySelectorAll('.instant-filter').forEach(el => {
        el.addEventListener('input', function() {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                document.getElementById('hiddenPageNumber').value = 1; // Сброс на 1 страницу
                document.getElementById('mainFilterForm').submit();
            }, 700); // Задержка 700мс
        });
    });

    // 2. Смена размера страницы
    function changePageSize(val) {
        document.getElementById('hiddenPageSize').value = val;
        document.getElementById('mainFilterForm').submit();
    }

    // 3. Управление колонками (localStorage)
    document.addEventListener('DOMContentLoaded', function() {
        const STORAGE_KEY = 'crm_contact_table_columns';
        const checkboxes = document.querySelectorAll('.col-chk');

        // Загрузка
        let savedCols = JSON.parse(localStorage.getItem(STORAGE_KEY));
        if (savedCols) {
            checkboxes.forEach(chk => {
                chk.checked = savedCols.includes(chk.value);
                toggleColumn(chk.value, chk.checked);
            });
        }

        // Клик
        checkboxes.forEach(chk => {
            chk.addEventListener('change', function() {
                toggleColumn(this.value, this.checked);
                const activeCols = Array.from(checkboxes).filter(i => i.checked).map(i => i.value);
                localStorage.setItem(STORAGE_KEY, JSON.stringify(activeCols));
            });
        });

        function toggleColumn(className, isVisible) {
            document.querySelectorAll('.' + className).forEach(el => {
                el.style.display = isVisible ? '' : 'none';
            });
        }
    });
</script>

<style>
    .page-link { border: none; background: transparent; padding: 0.5rem 0.75rem; color: #6c757d; font-weight: 500; }
    .page-item.active .page-link { background-color: #0d6efd !important; border-radius: 6px; color: white; }
    .table-hover tbody tr:hover { background-color: rgba(13, 110, 253, 0.03); cursor: pointer; }
    .dropdown-item:active { background-color: #f8f9fa; color: inherit; }
    .form-check-input:checked { background-color: #0d6efd; border-color: #0d6efd; }
</style>