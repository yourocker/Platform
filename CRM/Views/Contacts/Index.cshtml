@using Core.DTOs.CRM
@using Core.Entities.Platform
@using Core.UI.Grid
@model IEnumerable<ContactListDto>
@{
    Layout = "_EntityIndex";
    ViewData["Title"] = "Контакты";
    ViewData["Icon"] = "person-lines-fill";
    
    // Включаем стандартную панель (Фамилия, Имя, Телефон, Email) в _FilterPanel
    ViewData["ShowStandardFilters"] = true; 
    
    // Получаем конфиг таблицы из контроллера
    var gridConfig = ViewBag.GridConfig as GridConfig<ContactListDto>;
    ViewBag.ItemCount = Model?.Count() ?? 0;
}

@section HeaderControls {
    @* Меню выбора колонок генерируется автоматически на основе GridConfig *@
    <div class="dropdown">
        <button crm-button variant="outline-secondary" icon="view-list" class="dropdown-toggle shadow-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
            Вид
        </button>
        <ul class="dropdown-menu shadow border-0" style="max-height: 500px; overflow-y: auto; min-width: 250px;">
            <li><h6 class="dropdown-header">Колонки</h6></li>
            @if (gridConfig != null)
            {
                // Генерируем чекбоксы для всех колонок, кроме кнопок действий
                foreach (var col in gridConfig.Columns.Where(c => c.Type != GridColumnType.Actions))
                {
                    <li>
                        <div class="dropdown-item">
                            <div class="form-check">
                                @* Класс col-chk используется JS-скриптом entity-index.js для управления видимостью *@
                                <input class="form-check-input col-chk" type="checkbox" value="@col.SystemName" @(col.VisibleByDefault ? "checked" : "")> 
                                <label class="form-check-label">@col.Title</label>
                            </div>
                        </div>
                    </li>
                }
            }
        </ul>
    </div>
}

@section ActionButtons {
    <a asp-action="Create" crm-button variant="primary" icon="plus-lg" class="shadow-sm px-4">Создать</a>
}

@if (gridConfig != null && Model != null)
{
    <crm-grid config="@gridConfig" data="@Model" />
}
else
{
    <div class="p-4 text-center text-muted">
        Нет данных или конфигурации для отображения.
    </div>
}