@model Core.DTOs.CRM.ContactEditDto
@{
    ViewData["Title"] = "Редактирование";
}

<div class="container-fluid px-4">
    @* --- УНИФИЦИРОВАННЫЙ ХЕДЕР СТРАНИЦЫ --- *@
    <crm-page-header title="" icon="" subtitle="">
    </crm-page-header>

    <form asp-action="Edit" method="post" enctype="multipart/form-data">
        <input type="hidden" asp-for="Id" />

        <div class="row">
            <div class="col-lg-8">
                @* Секция 1: Основные данные (ФИО) *@
                <div crm-card>
                    <div class="card-body p-4">
                        <div class="row">
                            <div class="col-md-4">
                                <crm-input label="Фамилия" asp-for="LastName" required="required" />
                            </div>
                            <div class="col-md-4">
                                <crm-input label="Имя" asp-for="FirstName" required="required" />
                            </div>
                            <div class="col-md-4">
                                <crm-input label="Отчество" asp-for="MiddleName" />
                            </div>
                        </div>
                    </div>
                </div>

                @* Секция 2: Контакты *@
                <div crm-card class="mt-4">
                    
                    <div class="card-body p-4">
                        <div class="row g-4">
                            <div class="col-md-6 border-end">
                                <label class="form-label small fw-bold text-secondary mb-3">ТЕЛЕФОНЫ</label>
                                <div id="phones-container">
                                    @if (Model.PhoneNumbers != null && Model.PhoneNumbers.Any())
                                    {
                                        foreach (var phone in Model.PhoneNumbers)
                                        {
                                            <div class="input-group mb-2">
                                                <input type="tel" name="PhoneNumbers" value="@phone" class="form-control form-control-sm shadow-none">
                                                <button type="button" class="btn btn-sm btn-outline-danger shadow-none" onclick="this.parentElement.remove()"><i class="bi bi-x"></i></button>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="input-group mb-2">
                                            <input type="tel" name="PhoneNumbers" class="form-control form-control-sm shadow-none" placeholder="+7...">
                                        </div>
                                    }
                                </div>
                                <button type="button" class="btn btn-link btn-sm text-decoration-none p-0 mt-1" onclick="addCollectionItem('phones-container', 'PhoneNumbers', 'tel')">
                                    <i class="bi bi-plus-circle me-1"></i> Добавить номер
                                </button>
                            </div>

                            <div class="col-md-6 ps-md-4">
                                <label class="form-label small fw-bold text-secondary mb-3">EMAIL</label>
                                <div id="emails-container">
                                    @if (Model.EmailAddresses != null && Model.EmailAddresses.Any())
                                    {
                                        foreach (var email in Model.EmailAddresses)
                                        {
                                            <div class="input-group mb-2">
                                                <input type="email" name="EmailAddresses" value="@email" class="form-control form-control-sm shadow-none">
                                                <button type="button" class="btn btn-sm btn-outline-danger shadow-none" onclick="this.parentElement.remove()"><i class="bi bi-x"></i></button>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <div class="input-group mb-2">
                                            <input type="email" name="EmailAddresses" class="form-control form-control-sm shadow-none" placeholder="user@example.com">
                                        </div>
                                    }
                                </div>
                                <button type="button" class="btn btn-link btn-sm text-decoration-none p-0 mt-1" onclick="addCollectionItem('emails-container', 'EmailAddresses', 'email')">
                                    <i class="bi bi-plus-circle me-1"></i> Добавить email
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                @* Секция 3: Динамические поля *@
                <div crm-card>
                    <div class="card-body p-4">
                        <partial name="_DynamicFields" model="Model" />
                    </div>
                </div>

                @* --- БЛОК КНОПОК УПРАВЛЕНИЯ --- *@
                <div class="mt-4 pb-5 d-flex gap-2">
                    <button type="submit" crm-button variant="primary" icon="check-lg" class="px-5 py-2 fs-6 shadow">
                        Сохранить изменения
                    </button>
                    <a asp-action="Index" crm-button variant="outline-secondary" icon="x-lg" class="px-4 py-2 fs-6 shadow-none">
                        Отмена
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

<script>
    function addCollectionItem(containerId, name, type) {
        const container = document.getElementById(containerId);
        const div = document.createElement('div');
        div.className = 'input-group mb-2 animate__animated animate__fadeIn';
        div.innerHTML = `<input type="${type}" name="${name}" class="form-control form-control-sm shadow-none">
                         <button type="button" class="btn btn-sm btn-outline-danger shadow-none" onclick="this.parentElement.remove()"><i class="bi bi-x"></i></button>`;
        container.appendChild(div);
    }
</script>