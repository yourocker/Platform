@model IEnumerable<Core.Entities.Company.Department>
@{
    ViewData["Title"] = "Оргструктура";

    // Выносим рекурсивную функцию в основной блок кода, чтобы избежать вложенности @{ @{ ... } }
    async Task RenderTree(Guid? parentId, int level)
    {
        var children = Model.Where(d => d.ParentId == parentId).OrderBy(d => d.Name).ToList();
        if (!children.Any()) return;

        <ul class="list-unstyled @(level > 0 ? "ms-4 border-start ps-3 mt-3" : "")">
            @foreach (var dept in children)
            {
                <li class="mb-3">
                    <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded border shadow-sm">
                        <div>
                            <div class="fw-bold text-dark fs-5">@dept.Name</div>
                            
                            @if (dept.Manager != null && !dept.Manager.IsDismissed)                            {
                                <div class="small text-muted mt-1">
                                    <i class="bi bi-person-badge text-primary me-1"></i>
                                    <span>Руководитель: </span>
                                    <span class="fw-semibold">@dept.Manager.LastName @dept.Manager.FirstName</span>
                                </div>
                            }

                            @* Блок отображения сотрудников *@
                            @{
                                var activeStaff = dept.StaffAppointments?
                                    .Where(sa => sa.Employee != null && !sa.Employee.IsDismissed)
                                    .Select(sa => sa.Employee)
                                    .Distinct()
                                    .ToList();

                                if (activeStaff != null && activeStaff.Any())
                                {
                                    <div class="mt-2 d-flex flex-wrap gap-1">
                                        @foreach (var emp in activeStaff)
                                        {
                                            <span class="badge bg-white text-dark border fw-normal shadow-sm">
                                                <i class="bi bi-person text-secondary me-1"></i>
                                                @emp.LastName @(string.IsNullOrEmpty(emp.FirstName) ? "" : emp.FirstName[0] + ".")
                                            </span>
                                        }
                                    </div>
                                }
                            }
                        </div>
                        
                        @* Действия *@
                        <div class="btn-group btn-group-sm shadow-sm">
                            <a asp-action="Edit" asp-route-id="@dept.Id" 
                               crm-button variant="white" icon="pencil-fill" icon-class="text-primary" 
                               class="border" title="Редактировать"></a>
                               
                            <a asp-action="Delete" asp-route-id="@dept.Id" 
                               crm-button variant="white" icon="trash-fill" icon-class="text-danger" 
                               class="border" title="Удалить"></a>
                        </div>
                    </div>
                    
                    @* Рекурсивный вызов для вложенных уровней *@
                    @{ await RenderTree(dept.Id, level + 1); }
                </li>
            }
        </ul>
    }
}

<div class="container-fluid px-4">
    @* --- ХЕДЕР СТРАНИЦЫ --- *@
    <crm-page-header title="" icon="" subtitle="">
        <a asp-action="Create" crm-button variant="primary" icon="plus-lg" class="shadow-sm px-4">
            Добавить подразделение
        </a>
    </crm-page-header>

    @* --- ОСНОВНАЯ КАРТОЧКА --- *@
    <div crm-card>
        <div class="card-body p-4">
            @if (!Model.Any())
            {
                <crm-table-empty is-search="false" />
            }
            else
            {
                @* Запуск отрисовки дерева *@
                await RenderTree(null, 0);
            }
        </div>
    </div>
</div>

<style>
    .border-start { border-left: 2px dashed #dee2e6 !important; }
    .bg-light { background-color: #fcfcfc !important; }
    .badge { font-size: 0.75rem; }
</style>