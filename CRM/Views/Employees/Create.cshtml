@model Core.Entities.Company.Employee
@{
    ViewData["Title"] = "Новый сотрудник";
}

<script src="https://cdn.jsdelivr.net/npm/inputmask@5.0.8/dist/inputmask.min.js"></script>

<div class="container-fluid px-4">
    <crm-page-header title="" icon="" subtitle=""></crm-page-header>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            <form asp-action="Create" method="post">
                @* 1. Личные данные *@
                <div crm-card>
                    <div class="card-header bg-transparent border-0 pt-3 px-4"><h5 class="mb-0 fw-bold text-muted text-uppercase small">Личные данные</h5></div>
                    <div class="card-body p-4">
                        <div class="row g-3">
                            <div class="col-md-4"><crm-input label="Фамилия" name="LastName" required="required" /></div>
                            <div class="col-md-4"><crm-input label="Имя" name="FirstName" required="required" /></div>
                            <div class="col-md-4"><crm-input label="Отчество" name="MiddleName" /></div>
                        </div>
                    </div>
                </div>

                @* 2. Контакты *@
                <div class="row g-3">
                    <div class="col-md-6">
                        <div crm-card>
                            <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center pt-3 px-3">
                                <label class="small fw-bold text-muted text-uppercase">Телефоны</label>
                                <button type="button" crm-button variant="white" icon="plus-circle" class="btn-sm border-0 text-primary shadow-none" onclick="addInput('phone-list', 'Phones')"></button>
                            </div>
                            <div class="card-body p-3 pt-0" id="phone-list">
                                <div class="input-group mb-2">
                                    <input name="Phones" class="form-control form-control-sm shadow-none" placeholder="+7..." />
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div crm-card>
                            <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center pt-3 px-3">
                                <label class="small fw-bold text-muted text-uppercase">Email</label>
                                <button type="button" crm-button variant="white" icon="plus-circle" class="btn-sm border-0 text-primary shadow-none" onclick="addInput('email-list', 'Emails')"></button>
                            </div>
                            <div class="card-body p-3 pt-0" id="email-list">
                                <div class="input-group mb-2">
                                    <input name="Emails" class="form-control form-control-sm shadow-none" placeholder="example@mail.com" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                @* 3. Место работы (Совмещения) *@
                <div crm-card>
                    <div class="card-header bg-transparent border-0 pt-3 px-4"><h5 class="mb-0 fw-bold text-muted text-uppercase small">Место работы</h5></div>
                    <div class="card-body p-4 pt-0">
                        <div id="appointments-container">
                            <div class="row appointment-row mb-3 align-items-end g-2">
                                <div class="col-md-5">
                                    <label class="small text-muted mb-1 d-block fw-bold">Должность</label>
                                    <select name="selectedPositions" class="form-select form-select-sm shadow-none" required>
                                        @foreach(var p in (ViewBag.Positions as List<Core.Entities.Company.Position>)) { <option value="@p.Id">@p.Name</option> }
                                    </select>
                                </div>
                                <div class="col-md-5">
                                    <label class="small text-muted mb-1 d-block fw-bold">Подразделение</label>
                                    <select name="selectedDepartments" class="form-select form-select-sm shadow-none" required>
                                        @foreach(var d in (ViewBag.Departments as List<Core.Entities.Company.Department>)) { <option value="@d.Id">@d.Name</option> }
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-outline-danger btn-sm w-100 disabled shadow-none border-0" onclick="this.closest('.row').remove()"><i class="bi bi-trash"></i></button>
                                </div>
                            </div>
                        </div>
                        <button type="button" crm-button variant="outline-primary" icon="plus-lg" class="btn-sm mt-2" onclick="addAppointment()">Добавить совмещение</button>
                    </div>
                </div>

                @* 4. Динамические поля *@
                <div crm-card>
                    <div class="card-body p-4">
                        <partial name="_DynamicFields" model="null" />
                    </div>
                </div>

                @* 5. Доступ *@
                @if (User.Identity.Name == "admin" || User.Identity.Name?.Contains("awlwlb") == true)
                {
                    <div crm-card>
                        <div class="card-header bg-transparent border-0 pt-3 px-4"><h5 class="mb-0 fw-bold text-muted text-uppercase small">Доступ в систему</h5></div>
                        <div class="card-body p-4 pt-2">
                            <div class="row g-3">
                                <div class="col-md-6"><crm-input label="Логин (Email)" name="Login" autocomplete="off" /></div>
                                <div class="col-md-6"><crm-input label="Пароль" name="Password" type="password" autocomplete="new-password" /></div>
                            </div>
                        </div>
                    </div>
                }

                <div class="d-flex justify-content-end gap-2 mb-5 mt-4">
                    <a asp-action="Index" crm-button variant="outline-secondary" class="px-4">Отмена</a>
                    <button type="submit" crm-button variant="primary" icon="check-lg" class="px-5 shadow">Создать сотрудника</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function applyMasks() {
            Inputmask({"mask": "+7(999)999-99-99"}).mask(document.querySelectorAll('input[name="Phones"]'));
            Inputmask({"alias": "email"}).mask(document.querySelectorAll('input[name="Emails"]'));
        }
        document.addEventListener("DOMContentLoaded", applyMasks);
        function addInput(cId, name) {
            const c = document.getElementById(cId);
            const d = document.createElement('div'); 
            d.className = 'input-group mb-2 animate__animated animate__fadeIn';
            d.innerHTML = `<input name="${name}" class="form-control form-control-sm shadow-none">
                             <button type="button" class="btn btn-sm btn-outline-danger shadow-none border-0" onclick="this.parentElement.remove()"><i class="bi bi-trash"></i></button>`;
            c.appendChild(d);
            applyMasks();
        }
        function addAppointment() {
            const c = document.getElementById('appointments-container');
            const r = c.querySelector('.appointment-row').cloneNode(true);
            r.classList.add('animate__animated', 'animate__fadeIn');
            r.querySelector('.btn-outline-danger').classList.remove('disabled');
            r.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
            c.appendChild(r);
        }
    </script>
}