@model Core.Entities.Company.Employee

<script src="https://cdn.jsdelivr.net/npm/inputmask@5.0.8/dist/inputmask.min.js"></script>

<div class="row justify-content-center">
    <div class="col-md-9">
        <div class="d-flex align-items-center mb-4">
            <a asp-action="Index" class="btn btn-outline-secondary btn-sm me-3">
                <i class="bi bi-arrow-left"></i>
            </a>
            <h2 class="mb-0">Новый сотрудник</h2>
        </div>

        <form asp-action="Create" method="post">
            @* 1. Личные данные *@
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white py-3"><h5 class="mb-0 text-primary">Личные данные</h5></div>
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-md-4"><label class="fw-bold">Фамилия</label><input name="LastName" class="form-control" required /></div>
                        <div class="col-md-4"><label class="fw-bold">Имя</label><input name="FirstName" class="form-control" required /></div>
                        <div class="col-md-4"><label class="fw-bold">Отчество</label><input name="MiddleName" class="form-control" /></div>
                    </div>
                </div>
            </div>

            @* 2. Контакты *@
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white py-3"><h5 class="mb-0 text-primary">Контакты</h5></div>
                <div class="card-body p-4">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="fw-bold">Телефоны</label>
                            <div id="phone-list"><div class="input-group mb-2"><input name="Phones" class="form-control" /><button type="button" class="btn btn-outline-secondary" onclick="addInput('phone-list', 'Phones')">+</button></div></div>
                        </div>
                        <div class="col-md-6">
                            <label class="fw-bold">Email</label>
                            <div id="email-list"><div class="input-group mb-2"><input name="Emails" class="form-control" /><button type="button" class="btn btn-outline-secondary" onclick="addInput('email-list', 'Emails')">+</button></div></div>
                        </div>
                    </div>
                </div>
            </div>

            @* 3. Место работы *@
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white py-3"><h5 class="mb-0 text-primary">Место работы</h5></div>
                <div class="card-body p-4">
                    <div id="appointments-container">
                        <div class="row appointment-row mb-3 align-items-end">
                            <div class="col-md-5">
                                <label class="small text-muted">Должность</label>
                                <select name="selectedPositions" class="form-select" required>
                                    @foreach(var p in (ViewBag.Positions as List<Core.Entities.Company.Position>)) { <option value="@p.Id">@p.Name</option> }
                                </select>
                            </div>
                            <div class="col-md-5">
                                <label class="small text-muted">Подразделение</label>
                                <select name="selectedDepartments" class="form-select" required>
                                    @foreach(var d in (ViewBag.Departments as List<Core.Entities.Company.Department>)) { <option value="@d.Id">@d.Name</option> }
                                </select>
                            </div>
                            <div class="col-md-2"><button type="button" class="btn btn-outline-danger w-100 disabled" onclick="this.closest('.row').remove()"><i class="bi bi-trash"></i></button></div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addAppointment()">+ Добавить совмещение</button>
                </div>
            </div>
            
            @* 4. ДИНАМИЧЕСКИЕ ПОЛЯ ИЗ КОНСТРУКТОРА *@
            <partial name="_DynamicFields" model="null" />
            
            @if (User.Identity.Name == "admin" || User.Identity.Name?.Contains("awlwlb") == true) // Временная проверка на "Суперадмина"
            {
                <hr />
                <h4>Доступ в систему</h4>
                <div class="form-group mb-3">
                    <label class="control-label">Логин (Email)</label>
                    <input name="Login" class="form-control" autocomplete="off" />
                </div>
                <div class="form-group mb-3">
                    <label class="control-label">Пароль</label>
                    <input name="Password" type="password" class="form-control" autocomplete="new-password" />
                </div>
            }

            @* Кнопки действий *@
            <div class="d-flex justify-content-end gap-2 mb-5">
                <a asp-action="Index" class="btn btn-light px-4">Отмена</a>
                <button type="submit" class="btn btn-primary px-5">Создать сотрудника</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        // Функция применения масок
        function applyMasks() {
            Inputmask({"mask": "+7(999)999-99-99"}).mask(document.querySelectorAll('input[name="Phones"]'));
            Inputmask({"alias": "email"}).mask(document.querySelectorAll('input[name="Emails"]'));
        }

        // Запускаем при загрузке страницы
        document.addEventListener("DOMContentLoaded", applyMasks);
        
        // Добавление инпутов для контактов
        function addInput(cId, name) {
            const c = document.getElementById(cId);
            const d = document.createElement('div'); 
            d.className = 'input-group mb-2';
            d.innerHTML = `<input name="${name}" class="form-control"><button type="button" class="btn btn-outline-danger" onclick="this.parentElement.remove()">-</button>`;
            c.appendChild(d);
            applyMasks(); // Переприменяем маски для новых элементов
        }

        // Добавление совмещений
        function addAppointment() {
            const c = document.getElementById('appointments-container');
            const r = c.querySelector('.appointment-row').cloneNode(true);
            r.querySelector('.btn-outline-danger').classList.remove('disabled');
            // Сбрасываем выбранные значения в клоне
            r.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
            c.appendChild(r);
        }
    </script>
}