@model Core.Entities.Company.Employee
@{
    ViewData["Title"] = "Редактирование сотрудника";
    bool isLocked = Model.IsDismissed;
}

<script src="https://cdn.jsdelivr.net/npm/inputmask@5.0.8/dist/inputmask.min.js"></script>

@* Шаблон для назначений *@
<div id="appointment-template" style="display:none;">
    <div class="row appointment-row mb-3 align-items-end g-2">
        <div class="col-md-5">
            <label class="small text-muted mb-1 d-block fw-bold">Должность</label>
            <select name="selectedPositions" class="form-select form-select-sm">
                <option value="">-- Выберите должность --</option>
                @foreach(var p in (ViewBag.Positions as List<Core.Entities.Company.Position>)) { <option value="@p.Id">@p.Name</option> }
            </select>
        </div>
        <div class="col-md-5">
            <label class="small text-muted mb-1 d-block fw-bold">Подразделение</label>
            <select name="selectedDepartments" class="form-select form-select-sm">
                <option value="">-- Выберите подразделение --</option>
                @foreach(var d in (ViewBag.Departments as List<Core.Entities.Company.Department>)) { <option value="@d.Id">@d.Name</option> }
            </select>
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-outline-danger btn-sm border-0 w-100" onclick="this.closest('.row').remove()"><i class="bi bi-trash"></i></button>
        </div>
    </div>
</div>

<div class="container-fluid px-4">
    <crm-page-header title="" icon="" subtitle="">
        <div class="d-flex gap-2">
            @if (isLocked)
            {
                <form asp-action="Restore" asp-route-id="@Model.Id" method="post">
                    <button type="submit" crm-button variant="success" icon="person-check">Восстановить в штате</button>
                </form>
            }
            else
            {
                <form asp-action="Dismiss" asp-route-id="@Model.Id" method="post" onsubmit="return confirm('Вы уверены, что хотите уволить сотрудника?')">
                    <button type="submit" crm-button variant="outline-danger" icon="person-x">Уволить сотрудника</button>
                </form>
            }
        </div>
    </crm-page-header>

    <div class="row justify-content-center">
        <div class="col-lg-10">
            @if (isLocked)
            {
                <div class="alert alert-warning border-0 shadow-sm mb-4">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i> 
                    Сотрудник уволен. Редактирование данных невозможно до момента восстановления.
                </div>
            }

            <form asp-action="Edit" method="post" enctype="multipart/form-data">
                <input type="hidden" asp-for="Id" />
                <fieldset @(isLocked ? "disabled" : "")>
                    
                    @* 1. Личные данные *@
                    <div crm-card class="@(isLocked ? "bg-light opacity-75" : "")">
                        <div class="card-header bg-transparent border-0 pt-3 px-4"><h5 class="mb-0 fw-bold text-muted text-uppercase small">Личные данные</h5></div>
                        <div class="card-body p-4 pt-2">
                            <div class="row g-3">
                                <div class="col-md-4"><crm-input label="Фамилия" asp-for="LastName" required="required" /></div>
                                <div class="col-md-4"><crm-input label="Имя" asp-for="FirstName" required="required" /></div>
                                <div class="col-md-4"><crm-input label="Отчество" asp-for="MiddleName" /></div>
                            </div>
                        </div>
                    </div>

                    @* 2. Контакты *@
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div crm-card class="@(isLocked ? "bg-light" : "")">
                                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center pt-3 px-3">
                                    <label class="small fw-bold text-muted text-uppercase">Телефоны</label>
                                    @if(!isLocked){ <button type="button" crm-button variant="white" icon="plus-circle" class="btn-sm border-0 text-primary shadow-none" onclick="addInput('phone-list', 'Phones')"></button> }
                                </div>
                                <div class="card-body p-3 pt-0" id="phone-list">
                                    @foreach (var phone in Model.Phones)
                                    {
                                        <div class="input-group mb-2">
                                            <input name="Phones" class="form-control form-control-sm shadow-none" value="@phone" />
                                            @if(!isLocked){ <button type="button" class="btn btn-sm btn-outline-danger shadow-none border-0" onclick="this.parentElement.remove()"><i class="bi bi-trash"></i></button> }
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div crm-card class="@(isLocked ? "bg-light" : "")">
                                <div class="card-header bg-transparent border-0 d-flex justify-content-between align-items-center pt-3 px-3">
                                    <label class="small fw-bold text-muted text-uppercase">Email</label>
                                    @if(!isLocked){ <button type="button" crm-button variant="white" icon="plus-circle" class="btn-sm border-0 text-primary shadow-none" onclick="addInput('email-list', 'Emails')"></button> }
                                </div>
                                <div class="card-body p-3 pt-0" id="email-list">
                                    @foreach (var email in Model.Emails)
                                    {
                                        <div class="input-group mb-2">
                                            <input name="Emails" class="form-control form-control-sm shadow-none" value="@email" />
                                            @if(!isLocked){ <button type="button" class="btn btn-sm btn-outline-danger shadow-none border-0" onclick="this.parentElement.remove()"><i class="bi bi-trash"></i></button> }
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    @* 3. Динамические поля *@
                    <div crm-card class="@(isLocked ? "bg-light" : "")">
                        <div class="card-body p-4">
                            <partial name="_DynamicFields" model="Model" />
                        </div>
                    </div>

                    @* 4. Назначения *@
                    <div crm-card class="@(isLocked ? "bg-light" : "")">
                        <div class="card-header bg-transparent border-0 pt-3 px-4"><h5 class="mb-0 fw-bold text-muted text-uppercase small">Место работы</h5></div>
                        <div class="card-body p-4 pt-0">
                            <div id="appointments-container">
                                @foreach (var app in Model.StaffAppointments)
                                {
                                    <div class="row appointment-row mb-3 align-items-end g-2">
                                        <div class="col-md-5">
                                            <label class="small text-muted mb-1 d-block fw-bold">Должность</label>
                                            <select name="selectedPositions" class="form-select form-select-sm">
                                                @foreach(var p in (ViewBag.Positions as List<Core.Entities.Company.Position>)) 
                                                { <option value="@p.Id" selected="@(p.Id == app.PositionId)">@p.Name</option> }
                                            </select>
                                        </div>
                                        <div class="col-md-5">
                                            <label class="small text-muted mb-1 d-block fw-bold">Подразделение</label>
                                            <select name="selectedDepartments" class="form-select form-select-sm">
                                                @foreach(var d in (ViewBag.Departments as List<Core.Entities.Company.Department>)) 
                                                { <option value="@d.Id" selected="@(d.Id == app.DepartmentId)">@d.Name</option> }
                                            </select>
                                        </div>
                                        @if(!isLocked){ <div class="col-md-2"><button type="button" class="btn btn-sm btn-outline-danger border-0 w-100" onclick="this.closest('.row').remove()"><i class="bi bi-trash"></i></button></div> }
                                    </div>
                                }
                            </div>
                            @if(!isLocked){ <button type="button" crm-button variant="outline-primary" icon="plus-lg" class="btn-sm mt-2" onclick="addAppointment()">Добавить совмещение</button> }
                        </div>
                    </div>

                    @* 5. Доступ *@
                    <div crm-card class="@(isLocked ? "bg-light" : "")">
                        <div class="card-header bg-transparent border-0 pt-3 px-4">
                            <h5 class="mb-0 fw-bold text-muted text-uppercase small"><i class="bi bi-shield-lock me-1"></i> Доступ в систему</h5>
                        </div>
                        <div class="card-body p-4 pt-2">
                            @if (ViewBag.HasLogin == true)
                            {
                                <div class="row g-3 align-items-end">
                                    <div class="col-md-5"><crm-input label="Логин (Email)" name="Login" value="@Model.UserName" autocomplete="off" /></div>
                                    <div class="col-md-4"><crm-input label="Пароль" name="PassFake" value="********" readonly="readonly" /></div>
                                    <div class="col-md-3">
                                        <button type="button" crm-button variant="outline-danger" icon="key" class="w-100" data-bs-toggle="modal" data-bs-target="#resetPasswordModal">Сменить пароль</button>
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-warning border-0 small shadow-sm"><i class="bi bi-exclamation-circle me-1"></i> У сотрудника нет доступа. Заполните поля ниже для создания записи.</div>
                                <div class="row g-3">
                                    <div class="col-md-6"><crm-input label="Логин (Email)" name="Login" placeholder="ivanov@example.com" autocomplete="off" /></div>
                                    <div class="col-md-6"><crm-input label="Создайте Пароль" name="NewPassword" type="password" autocomplete="new-password" /></div>
                                </div>
                            }
                        </div>
                    </div>

                    @if (!isLocked)
                    {
                        <div class="d-flex justify-content-end gap-2 mb-5 mt-4">
                            <a asp-action="Index" crm-button variant="outline-secondary" class="px-4">Отмена</a>
                            <button type="submit" crm-button variant="primary" icon="check-lg" class="px-5 shadow">Сохранить изменения</button>
                        </div>
                    }
                </fieldset>
            </form>
        </div>
    </div>
</div>

@* Модальное окно сброса пароля *@
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-danger text-white border-0">
                <h5 class="modal-title fw-bold">Смена пароля сотрудника</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p class="small">Установка нового пароля для <strong>@Model.FullName</strong>. Старый пароль будет сброшен.</p>
                <form id="adminResetPassForm">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" value="@Model.Id" />
                    <div class="mb-4"><crm-input label="Новый пароль" name="newPassword" type="password" required="required" /></div>
                    <div class="d-grid"><button type="submit" crm-button variant="danger" icon="check-circle">Установить пароль</button></div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        function applyMasks() {
            Inputmask({"mask": "+7(999)999-99-99"}).mask(document.querySelectorAll('input[name="Phones"]'));
            Inputmask({"alias": "email"}).mask(document.querySelectorAll('input[name="Emails"]'));
        }
        document.addEventListener("DOMContentLoaded", applyMasks);
        function addInput(cId, name) {
            const c = document.getElementById(cId);
            const d = document.createElement('div'); d.className = 'input-group mb-2 animate__animated animate__fadeIn';
            d.innerHTML = `<input name="${name}" class="form-control form-control-sm shadow-none">
                             <button type="button" class="btn btn-sm btn-outline-danger shadow-none border-0" onclick="this.parentElement.remove()"><i class="bi bi-trash"></i></button>`;
            c.appendChild(d);
            applyMasks();
        }
        function addAppointment() {
            const container = document.getElementById('appointments-container');
            const template = document.getElementById('appointment-template');
            const newRow = template.querySelector('.appointment-row').cloneNode(true);
            newRow.classList.add('animate__animated', 'animate__fadeIn');
            newRow.querySelectorAll('select').forEach(select => select.value = "");
            container.appendChild(newRow);
        }
        $('#adminResetPassForm').on('submit', function(e) {
            e.preventDefault();
            var form = $(this);
            var btn = form.find('button[type="submit"]');
            btn.prop('disabled', true).text('Сохранение...');
            $.post('/Employees/AdminResetPassword', form.serialize())
                .done(function() {
                    alert('Пароль успешно изменен!');
                    $('#resetPasswordModal').modal('hide');
                    form[0].reset();
                })
                .fail(function(xhr) { alert('Ошибка: ' + xhr.responseText); })
                .always(function() { btn.prop('disabled', false).html('<i class="bi bi-check-circle me-1"></i> Установить пароль'); });
        });
    </script>
}